<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Bike Curious Homepage - In Development</title>
  <meta name="description" content="index.html">
  <meta name="author" content="BikeCurious">

  <link href="{{ url_for('static', filename='style.css')}}" rel="stylesheet" type="text/css">

    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">

        function initCharts(){
            // Load the Visualization API and the corechart package.
      google.charts.load('current', {'packages':['corechart']});

      // Set a callback to run when the Google Visualization API is loaded.
      google.charts.setOnLoadCallback(initMap);
        }
      
    </script>
    
</head>

<body>
  <p> Hello {{ name }}</p>

  <div id="map"></div>
  <div id="chart1"></div>
    <div id="chart2"></div>
<script>
let map;

function initMap() {

  // fetching the static data
  fetch("/stations").then(response => {
      return response.json();
      }).then(data => {
      console.log("data ", data);

  // fetching the available bikes data
  fetch("/bikes").then(bikeResponse => {
      return bikeResponse.json();
      }).then(bikeData => {
      console.log("bikeData ", bikeData);


  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 53.349804, lng: -6.260310 },
    zoom: 13,
    });

  // iterating over each station
  data.forEach(station => {

    var contentString;
    // iterating over the availability data and building the content for the info window
    bikeData.forEach(bikeStation => {
      if (station.name == bikeStation.StationName) {
        contentString = `${bikeStation.StationName} Avail Stands: ${bikeStation.AvailableBikeStands} Avail Bikes: ${bikeStation.AvailableBikes}`;
        }
      });

    // info window for each marker
    const infowindow = new google.maps.InfoWindow({
      content: contentString,
    });

    // adding the markers
    const marker = new google.maps.Marker({
      position: { lat: parseFloat(station.latitude), lng: parseFloat(station.longitude) },
      map: map,
    });

    // event handler for click
    marker.addListener("click", () => {
      infowindow.open(map, marker);
        chartWeekly(station.number);
        console.log('now to chart hourly with' + station.number);
        chartHourly(station.number);
    });
  });

    }).catch(err => {
      console.log("OOPS!", err);
  });
  });
}
    
function chartWeekly(StationNumber){
    // Called when user clicks on marker
    // Draws charts at bottom of page
    fetch("/chartW/" + StationNumber).then(response => {
        return response.json();
    }).then(data =>{
            console.log(data);
    
        var options = {
            'title': 'Available Bikes',
            'width': 300, 'height': 300
        };
        var chart = new google.visualization.ColumnChart(document.getElementById('chart1'));
        var chartData = new google.visualization.DataTable();
        chartData.addColumn('number', "Day Of Week");
        chartData.addColumn('number', "Bike Availability");
        data.forEach(y =>{
            chartData.addRow([y.DayOfWeek, y.AvailableBikes]);
        })
        chart.draw(chartData, options);
            });
}
    
function chartHourly(StationNumber){
        // Called when user clicks on marker
    // Draws charts at bottom of page
    fetch("/chartH/" + StationNumber).then(response => {
        return response.json();
    }).then(data =>{
            console.log(data);
    
        var options = {
            'title': 'Available Bikes',
            'width': 300, 'height': 300
        };
        var chart = new google.visualization.ColumnChart(document.getElementById('chart2'));
        var chartData = new google.visualization.DataTable();
        chartData.addColumn('number', "Day Of Week");
        chartData.addColumn('number', "Bike Availability");
        data.forEach(y =>{
            chartData.addRow([y.Hour, y.AvailableBikes]);
        })
        chart.draw(chartData, options);
            });
    
}
  </script>

 <script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBNMDKUUBsPVblrArwU5AIKEt8ZirRosf4&callback=initCharts&libraries=&v=weekly"
      async>
</script>

</body>
</html>